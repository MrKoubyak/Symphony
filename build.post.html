<!doctype html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1">

<!-- Page information -->
<title>
    YAKA Studio | Direct Line API 3.0
    
</title>
<meta name="description" content="Understand communication between your bot and Unity by using the Direct Line API.">

<!-- Site information -->
<meta name="author" content="YAKA Game Studio">
<link type="text/plain" rel="author" href="http://studio.yaka.cloud/humans.txt"/>
<link rel="canonical" href="http://studio.yaka.cloud">

<!-- Style -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">

<link rel="stylesheet" type="text/css" href="build.css">

<!-- Website Meta -->
<meta property="og:title" content="Direct Line API 3.0" />
<meta property="og:url" content="http://studio.yaka.cloud" />
<meta property="og:site_name" content="YAKA Studio">
<meta property="og:type" content="website" />
<meta property="og:image" content="http://studio.yaka.cloud/images/icons/dark/yaka-games-logo.png" />
<meta property="og:description" content="Understand communication between your bot and Unity by using the Direct Line API." />

<!-- Browser Manifest -->
<link rel="manifest" href="http://studio.yaka.cloud/site.webmanifest">
<meta name="msapplication-config" content="http://studio.yaka.cloud/browserconfig.xml" />

<!-- Fav Icons -->
<link rel="apple-touch-icon" href="http://studio.yaka.cloud/assets/images/icons/dark/iOS/icon_180.png" sizes="180x180">
<link rel="icon" href="http://studio.yaka.cloud/assets/images/icons/dark/Android/icon_72.png" sizes="72x72" type="image/png">
<link rel="icon" href="http://studio.yaka.cloud/assets/images/icons/favicon.ico">


</head>
<body class="bg-light">
    <!-- Header -->
    <header id="header">
    <!-- Social Network -->
    <span class="d-lg-none spacer">&nbsp;</span>
    <div id="NavTop" class="d-none d-lg-block">
        
        <ul class="nav justify-content-end">
            
            <li class="nav-item">
                <a class="nav-link" href="https://twitter.com/yakagamestudio" title="Follow us on Twitter"><i class="fab fa-twitter"></i></a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="https://facebook.com/yakagamestudio" title="Follow us on Facebook"><i class="fab fa-facebook"></i></a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="https://instagram.com/yakagamestudio" title="Follow us on Instagram"><i class="fab fa-instagram"></i></a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="https://www.linkedin.com/showcase/yakagamestudio" title="Follow us on Linkedin"><i class="fab fa-linkedin"></i></a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="https://www.pinterest.fr/YAKAGameStudio" title="Follow us on Pinterest"><i class="fab fa-pinterest"></i></a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="https://www.twitch.tv/yakagamestudio" title="Follow us on Twitch"><i class="fab fa-twitch"></i></a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="https://www.youtube.com/channel/UCqhzZEPsQ18xUt0vc1pekCw" title="Follow us on Youtube"><i class="fab fa-youtube"></i></a>
            </li>
            
        </ul>
        
    </div>

    <!-- Site Menu -->
    <nav id="NavMain" class="navbar navbar-expand-lg navbar-light">
        <div class="container border rounded bg-white p-2 shadow">
            <!-- Logo -->
            <div id="logo" class="border rounded bg-white shadow">
                <a href="http://studio.yaka.cloud" title="YAKA Studio">
                    <img src="http://studio.yaka.cloud/assets/images/logo.png" width="100" alt="YAKA Studio">
                </a>
            </div>

            <!-- Responsive Toggle Button -->
            <button 
                class="navbar-toggler" 
                type="button" 
                data-bs-toggle="collapse" 
                data-bs-target="#navbarContent" 
                aria-controls="navbarContent" 
                aria-expanded="false" 
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navigation -->
            <div id="navbarContent" class="collapse navbar-collapse p-2 pt-5 p-lg-0">
                
                <!-- Site -->
                <div id="sitemap" class="me-auto">
                    <ul class="navbar-nav nav-pills">
                        
                        <li class="nav-item">
                            <a class="nav-link" 
                             
                            href="http://studio.yaka.cloud/">
                                Home
                            </a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link" 
                             
                            href="http://studio.yaka.cloud/about.html">
                                About
                            </a>
                        </li>
                        
                    </ul>
                </div>
                
                <hr />
                
                <!-- Network -->
                <div id="network">
                    <ul class="navbar-nav">
                        
                        <li class="nav-item">
                            <a class="nav-link" href="https://yaka.games" title="YAKA Games">
                                
                                YAKA Games
                            </a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link" href="https://play.yaka.games" title="YAKA Play">
                                <i class="fas fa-play-circle"></i>
                                YAKA Play
                            </a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link" href="https://yaka.studio" title="YAKA Studio">
                                
                                YAKA Studio
                            </a>
                        </li>
                        
                    </ul>
                </div>
                
                <hr />
                
                <!-- Social Network -->
                <div class="d-lg-none">
                    <h4>Follow us</h4>
                    <ul class="nav justify-content-center ">
                        
                        <li class="nav-item">
                            <a class="nav-link link-light" href="https://twitter.com/yakagamestudio" title="Follow us on Twitter"><i class="fab fa-twitter"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link link-light" href="https://facebook.com/yakagamestudio" title="Follow us on Facebook"><i class="fab fa-facebook"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link link-light" href="https://instagram.com/yakagamestudio" title="Follow us on Instagram"><i class="fab fa-instagram"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link link-light" href="https://www.linkedin.com/showcase/yakagamestudio" title="Follow us on Linkedin"><i class="fab fa-linkedin"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link link-light" href="https://www.pinterest.fr/YAKAGameStudio" title="Follow us on Pinterest"><i class="fab fa-pinterest"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link link-light" href="https://www.twitch.tv/yakagamestudio" title="Follow us on Twitch"><i class="fab fa-twitch"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link link-light" href="https://www.youtube.com/channel/UCqhzZEPsQ18xUt0vc1pekCw" title="Follow us on Youtube"><i class="fab fa-youtube"></i></a>
                        </li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </nav>
</header>

    <!-- Hero -->
<section class="hero position-relative post">
    

    
    <picture>
        <source media="(min-width:800px)" srcset="http://studio.yaka.cloud/assets/images/illustrations/chatbot.jpg">
        <img src="http://studio.yaka.cloud/assets/images/illustrations/chatbot.jpg" alt="Direct Line API 3.0" class="background">
    </picture>
    

    <div class="container position-absolute top-50 start-50 translate-middle">
        <h1 class="display-4">Direct Line API 3.0</h1>
        
        <p class="lead">Understand communication between your bot and Unity by using the Direct Line API.</p>
        
    </div>
</section>

<!-- Content -->
<main class="p-3 bg-white" aria-label="Content">
    <article class="container">
        <header>
            <p>
                 -   
                
            </p>
        </header>
        <section>
            <p>You can enable communication between your <a href="/Azure/bot/">bot</a> and Unity by using the <code class="language-plaintext highlighter-rouge">Direct Line API</code>.
I will explain how to do it in Unity but also provide some information about the mechanism.</p>

<h2 id="authentication">Authentication</h2>
<p>Direct Line API 3.0 requests can be authenticated either by using a secret that you obtain from the Direct Line channel configuration page in the Azure Portal or by using a token that you obtain at runtime.</p>

<ul>
  <li>A Direct Line <code class="language-plaintext highlighter-rouge">secret</code> is a master key that can be used to access any conversation that belongs to the associated bot. A secret can also be used to obtain a token. Secrets do not expire.</li>
  <li>A Direct Line <code class="language-plaintext highlighter-rouge">token</code> is a key that can be used to access a single conversation. A token expires but can be refreshed.</li>
</ul>

<h2 id="starting-conversation">Starting conversation</h2>
<p><a href="https://docs.microsoft.com/en-us/azure/bot-service/rest-api/bot-framework-rest-direct-line-3-0-start-conversation?view=azure-bot-service-4.0" target="_blank">Additional Reading</a>
Direct Line conversations are explicitly opened by clients and may run as long as the bot and client participate and have valid credentials.
While the conversation is open, both the bot and client may send messages.</p>

<blockquote>
  <p>More than one client may connect to a given conversation and each client may participate on behalf of multiple users.</p>
</blockquote>

<p>To open conversation, issue a POST Request to the endpoint</p>

<pre><code class="language-HTTP">POST https://directline.botframework.com/v3/directline/conversations
Authorization: Bearer `SECRET` OR `TOKEN`
</code></pre>

<p>If the request is successful, the response will contain an ID for the conversation, a token, a value that indicates the number of seconds until the token expires, and a stream URL that the client may use to receive activities.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"conversationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-ABC-"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-123-"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"expires_in"</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="p">,</span><span class="w">
    </span><span class="nl">"streamUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"wss://directline.botframework.com/v3/directline/conversations/-ABC-/stream?watermark=-&amp;t=-123-"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"referenceGrammarId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ddf0cd2c-b093-595c-b951-8431afebed17"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>To perform this action in Unity, we have to:</p>
<ul>
  <li>Call the HTTP Service and store the answer for later purpose.</li>
  <li>Initiate discussion to have the greetings (optional - see <a href="https://docs.microsoft.com/en-us/azure/bot-service/bot-service-channels-reference?view=azure-bot-service-4.0#categorized-activities-by-channel">Microsoft Bot Channel activities</a></li>
</ul>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="n">IEnumerator</span> <span class="nf">StartConversation</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// Compose Directline Endpoint</span>
  <span class="kt">string</span> <span class="n">conversationEndpoint</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"{0}/conversations"</span><span class="p">,</span> <span class="n">botEndpoint</span><span class="p">);</span>

  <span class="c1">// Create a empty webform to perform post</span>
  <span class="n">WWWForm</span> <span class="n">webForm</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WWWForm</span><span class="p">();</span>

  <span class="c1">// Call HTTP Service with Unity - See https://docs.unity3d.com/ScriptReference/Networking.UnityWebRequest.html</span>
  <span class="k">using</span> <span class="p">(</span><span class="n">UnityWebRequest</span> <span class="n">uwr</span> <span class="p">=</span> <span class="n">UnityWebRequest</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">conversationEndpoint</span><span class="p">,</span> <span class="n">webForm</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="c1">// Define Auth header</span>
    <span class="n">uwr</span><span class="p">.</span><span class="nf">SetRequestHeader</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span> <span class="s">"Bearer "</span> <span class="p">+</span> <span class="n">botSecret</span><span class="p">);</span>
    <span class="c1">// Define temp storage for answer</span>
    <span class="n">uwr</span><span class="p">.</span><span class="n">downloadHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DownloadHandlerBuffer</span><span class="p">();</span>

    <span class="c1">// Send &amp; Wait for answer</span>
    <span class="k">yield</span> <span class="k">return</span> <span class="n">uwr</span><span class="p">.</span><span class="nf">SendWebRequest</span><span class="p">();</span>

    <span class="c1">// Manage answer if no faillure</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uwr</span><span class="p">.</span><span class="n">result</span> <span class="p">!=</span> <span class="n">UnityWebRequest</span><span class="p">.</span><span class="n">Result</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">Debug</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">$"BOT | StartConversation | Request error: </span><span class="p">{</span><span class="n">uwr</span><span class="p">.</span><span class="n">error</span><span class="p">}</span><span class="s"> \n Status: </span><span class="p">{</span><span class="n">uwr</span><span class="p">.</span><span class="n">responseCode</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="c1">// Catch the answer</span>
      <span class="kt">string</span> <span class="n">jsonResponse</span> <span class="p">=</span> <span class="n">uwr</span><span class="p">.</span><span class="n">downloadHandler</span><span class="p">.</span><span class="n">text</span><span class="p">;</span>

      <span class="c1">// Create Conversation to store authentication</span>
      <span class="n">conversation</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Conversation</span><span class="p">();</span>
      <span class="n">conversation</span> <span class="p">=</span> <span class="n">JsonUtility</span><span class="p">.</span><span class="n">FromJson</span><span class="p">&lt;</span><span class="n">Conversation</span><span class="p">&gt;(</span><span class="n">jsonResponse</span><span class="p">);</span>

      <span class="c1">// Create Activities to store conversation messages</span>
      <span class="n">activities</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Activities</span><span class="p">();</span>

      <span class="c1">// Set the Bot Status</span>
      <span class="n">conversationStarted</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span> 

      <span class="c1">// Request a first "introduction" from the Bot</span>
      <span class="k">if</span><span class="p">(</span><span class="n">greetings</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="c1">// The following call is necessary to create and inject an activity of type "conversationUpdate" to get greetings from your bot</span>
        <span class="nf">StartCoroutine</span><span class="p">(</span><span class="nf">SendMessageToBot</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="n">botId</span><span class="p">,</span> <span class="n">botName</span><span class="p">,</span> <span class="s">"conversationUpdate"</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="sending-messages">Sending messages</h2>
<p><a href="https://docs.microsoft.com/en-us/azure/bot-service/rest-api/bot-framework-rest-direct-line-3-0-send-activity?view=azure-bot-service-4.0">Additional Reading</a>
By using <code class="language-plaintext highlighter-rouge">Direct Line API</code>, Unity can send messages to your bot by issuing HTTP <code class="language-plaintext highlighter-rouge">POST</code> requests.</p>

<blockquote>
  <p>You may send a single message per request.</p>
</blockquote>

<p>To send a message to the bot, the client must create an Activity and then issue a request to <code class="language-plaintext highlighter-rouge">https://directline.botframework.com/v3/directline/conversations/{conversationId}/activities</code>, specifying the Activity object in the body of the request.</p>

<pre><code class="language-HTTP">POST https://directline.botframework.com/v3/directline/conversations/abc123/activities
Authorization: Bearer RCurR_XV9ZA.cwA.BKA.iaJrC8xpy8qbOF5xnR2vtCX7CZj0LdjAPGfiCpg4Fv0
Content-Type: application/json
[other headers]
</code></pre>
<pre><code class="language-JSON">{
    "locale": "en-EN",
    "type": "message",
    "from": {
        "id": "user1"
    },
    "text": "hello"
}
</code></pre>

<p>When the activity is delivered to the bot, the service responds with an HTTP status code that reflects the bot’s status code. If the POST is successful, the response contains a JSON payload that specifies the ID of the Activity that was sent to the bot.</p>

<pre><code class="language-C#">private IEnumerator SendMessageToBot(string message, string activityType)
{
    // Compose Directline Endpoint
    string activityEndpoint = string.Format("{0}/conversations/{1}/activities", botEndpoint, conversation.conversationId);

    // Create a empty webform to perform post
    WWWForm webForm = new WWWForm();

    // Create a new activity
    Activity activity = new Activity();
    // Provide Conversation Id
    activity.conversation = new ConversationReference();
    activity.conversation.id = conversation.conversationId;
    // Provide Sender Information
    activity.from = new UserAccount();
    activity.from.id = playerId;
    activity.from.name = playerName;
    // Provide Message
    activity.text = message;
    // Provide content Type
    activity.type = activityType;
    // Provide Channel used
    activity.channelId = "DirectLineChannelId";

    // Serialize the activity
    string json = JsonUtility.ToJson(activity);

    // Call HTTP Service with Unity - See https://docs.unity3d.com/ScriptReference/Networking.UnityWebRequest.html
    using (UnityWebRequest uwr = UnityWebRequest.Post(activityEndpoint, webForm))
    {
        // Define Auth header
        uwr.SetRequestHeader("Authorization", "Bearer " + botSecret);
        // Define temp storage for answer
        uwr.downloadHandler = new DownloadHandlerBuffer();
        // Define
        uwr.uploadHandler = new UploadHandlerRaw(Encoding.UTF8.GetBytes(json));
        // Define Content format
        uwr.uploadHandler.contentType = "application/json";

        // Send &amp; Wait for answer
        yield return uwr.SendWebRequest();

        // Manage answer if no faillure
        if (uwr.result != UnityWebRequest.Result.Success)
        {
            Debug.LogError($"BOT | StartConversation | Request error: {uwr.error} \n Status: {uwr.responseCode.ToString()}");
        }
        else
        {
            // Catch the answer
            string jsonResponse = uwr.downloadHandler.text;

            // Create ActivtyReference to store latest message
            activityReference = new ActivityReference();
            activityReference = JsonUtility.FromJson&lt;ActivityReference&gt;(jsonResponse);
            // Add a timestamp
            activityReference.time = Time.time;

            // Get the Bot Service Answer
            StartCoroutine(GetResponseFromBot(activity));
        }
    }
}
</code></pre>

<h2 id="receiving-messages">Receiving messages</h2>
<p>Using Direct Line API 3.0, a client can receive messages from your bot either via WebSocket stream or by issuing HTTP GET requests. Using either of these techniques, a client may receive multiple messages from the bot at a time as part of an ActivitySet. For more information, see Receive activities from the bot.</p>

<h2 id="conversation">Conversation</h2>

<h2 id="message">Message</h2>

        </section>
        <footer>
    
        </footer>
    </article>
</main>
  
    <!-- footer -->
    <footer id="footer" class="bg-light border-top text-muted pt-3">
    <div class="container">
        <div class="row">
            
            <!-- Social Media -->
            <div id="social" class="col-sm-12 col-lg-6">
                <h2 class="h5">Let's Connect</h2>
                <p>Follow us on your favorite platform</p>
                <div>
                    <ul class="nav pb-3">
                        
                        <li class="nav-item">
                            <a class="nav-link" href="https://twitter.com/yakagamestudio" title="Follow us on Twitter"><i class="fab fa-twitter"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link" href="https://facebook.com/yakagamestudio" title="Follow us on Facebook"><i class="fab fa-facebook"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link" href="https://instagram.com/yakagamestudio" title="Follow us on Instagram"><i class="fab fa-instagram"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link" href="https://www.linkedin.com/showcase/yakagamestudio" title="Follow us on Linkedin"><i class="fab fa-linkedin"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link" href="https://www.pinterest.fr/YAKAGameStudio" title="Follow us on Pinterest"><i class="fab fa-pinterest"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link" href="https://www.twitch.tv/yakagamestudio" title="Follow us on Twitch"><i class="fab fa-twitch"></i></a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link" href="https://www.youtube.com/channel/UCqhzZEPsQ18xUt0vc1pekCw" title="Follow us on Youtube"><i class="fab fa-youtube"></i></a>
                        </li>
                        
                    </ul>
                </div>
            </div>
            
            <!-- Links -->
            
        </div>
        <!-- Copyright -->
        <div id="disclaimer" class="row border-top py-3">
            <div id="copyright" class="col-sm-6">
                <p>Copyright &copy; 2022 YAKA Game Studio</p>
            </div>
            <div id="lydde" class="col-sm-6 text-end d-none d-md-block">
                <a href="https://lydde.com">
                    <img src="https://lydde.com/wp-content/uploads/2020/11/Teams-Invite.png"
                         alt="YAKA Game Studio is a subsidiary of LYDDE">
                </a>
            </div>
        </div>
    </div>
</footer>


    <!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" 
        crossorigin="anonymous">
</script>
<!-- Site Script -->
<script src="http://studio.yaka.cloud/assets/scripts/main.js"></script>

</body>
</html>
